---
title: "Федоров Олег БЭК-172, Домашка"
output: word_document
lang: russian
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r,include=FALSE}
library("psych")
library("dplyr")
library("ggplot2")
library("GGally")
library("knitr")
library("pander")
library("memisc")
library("jtools")
library("car")
library("mctest")
library("tsoutliers")
library("lmtest")


#считываем данные

fireinitial <- read.csv("forestfires.csv")
```

Задание 2. Я включаю в модель следующие признаки:
1.	Температура(temp). При высокой температуре воздуха лес и трава быстрее становятся более сухими, и значит, легче загораются. Длительная жара может привести к горению торфяников, как это было в Москве и МО летом 2010-ого. Лесные пожары обычно происходят в теплое время года. Поэтому, я ожидаю положительную взаимосвязь между площадью лесного пожара и температурой воздуха – знак ”+”.
2.	Относительная влажность воздуха(RH). Пожары распространяются лучше в сухую погоду, когда много “топлива” - сухого горючего леса и сухой травы, во влажную погоду этого топлива меньше. Предполагаю, что увеличение влажности отрицательно влияет на площадь пожара – знак при коэффициенте – “-”.
3.	Скорость ветра (wind) – беру, потому что ветер разносит лесной пожар, увеличивая его площадь. Я думаю, что скорость ветра будет положительно влиять на площадь пожара – знак ”+”.
4.	DMC - (это индикатор влажности среднего слоя лесного покрова, более высокие значения соответствуют более низкой влажности).  Сухой лесной покров легче воспламеняется и увеличивает вероятность возникновения пожара большой площади. Сухой слой лесного покрова может воспламениться от удара молнии. Ожидаю, что при данном признаке в модели будет положительный коэффициент.
5.	Я хотел бы включить в регрессоры переменную взаимодействия, которая бы показывала насколько погода сухая, жаркая и ветреная одновременно. Есть предположение, что ожидаемая площадь пожара гораздо выше, когда все благоприятствующие погодные условия наблюдаются одновременно. А в сухую и холодную погоду мы, наоборот, не ожидаем крупного пожара. Переменная называется synergy и задается уравнением:

synergy= temp∙ln⁡(1+wind)∙((100-RH)/10)^2


Интуиция фоормулы: для распространения пожара достаточно небольшого ветра, температура скорее должна быть достаточно
высокой, а влажность небольшой.Ожидаю при переменной знак "+".

Диаграммы рассеяния и корреляции, дескриптивные статистики, гистограммы
```{r, include=FALSE}
dffires <- subset(fireinitial[c(6, 9:11, 13)], area > 0)
synergy <- dffires['temp']*log1p(dffires['wind'])*((100-dffires['RH'])/10)^2
dffires <- data.frame(dffires, synergy)
colnames(dffires)[6] <- "synergy"
```
```{r}
ggpairs(dffires)
describe(dffires)
qplot(data = dffires, DMC, ylab="Показатель индекса", main = "Распределение DMC")
qplot(data = dffires, temp, ylab="Градусов Цельсия", main = "Распределение температуры")
qplot(data = dffires, RH, ylab="Относительная влажность,%", main = "Распределение влажности воздуха")
qplot(data = dffires, wind, ylab="Скорость ветра,км/ч", main = "Распределение силы ветра")
qplot(data = dffires, area, ylab="Площадь лесных пожаров", main = "Распределение площади лесных пожаров")
qplot(data = dffires, synergy, ylab="показатель индекса", main = "Распределение синергии")
```

Визуальная интерпретация данных: распределения наблюдений у признаков достаточно однородны.Целевая переменная проблемная. Большинство пожаров достаточно небольшие, но есть доля достаточно крупных пожаров и несколько аномально крупных. Сказать, что это выбросы мы не можем, так как идея предложенной статистики - это именно изучение причин возникновения крупных пожаров.

Задание 3. Проверка модели на мультиколлинеарность.

Я проверяю модель на мультиколлинеарность с помощью тестов VIF, CN и некоторых других, предложенных библиотекой mctest.

```{r,include=FALSE}
# Модель: линейная регрессия
model_fires <- lm(data = dffires, area ~ DMC+temp+RH+wind+synergy)
summary(model_fires)
```

```{r}
vif(model_fires)
omcdiag(model_fires,cn = 30)
```
Максимальный показатель VIF - 7.49 для признака synergy: действительно - это вектор, скомбинированный из других векторов в модели, но это приемлемый показатель VIF , < 10, значит явной мультиколлинеарности в модели нет.
Показатель теста Condition Number - 19.61, что меньше 30 - стандартного порога для мультиколлинеарности. Соответственно, мультиколлинеарности в модели нет. Настоящие ковбои не отвлекаются на всякую ерунду)))).

Задание 4. Оцениваю линейную модель:

```{r}
# Модель: линейная регрессия
model_fires <- lm(data = dffires, area ~ DMC+temp+RH+wind+synergy)
summary(model_fires)
```
Это связано с тем, что переменная взаимодействия перетягивает коэффициенты от переменных temp, RH, и wind, так как она лучше объясняет модель.Если исключить переменную взаимодействия, то знаки при всех остальных признаках совпадут с предсказанными.
А вот R^2 регрессии равен 0.037 - что же поделать, такие данные. Коэффициент при synergy является значиым на уровне значимости 5%, для остальных переменных гипотеза о незначимости не отвергается для любых уровней разумных 
уровней значимости. Гипотеза об адекватности регрессии не отвергается на уровне значимотси 10%. В целом, 
регрессия показывает, что существует слабая зависимость между указанными погодными условиями и площадью пожара для 
конкретного природного парка в Португалии.

Проверяем остатки на нормальность с помощью теста Харке-Бера

`r JarqueBera.test(residuals(model_fires))`

Этот тест отвергает нормальное распределение остатков в моей модели.

Задание 5.

Находим медианные значения для признаков
```{r}
median(dffires$DMC)
median(dffires$temp)
median(dffires$RH)
median(dffires$wind)
median(dffires$synergy)

nw <- data.frame( DMC = c(median(dffires$DMC)),temp = c(median(dffires$temp)), 
                RH = c(median(dffires$RH)), wind = c(median(dffires$wind)), 
                synergy =median(dffires$synergy))
```

Точечный прогноз:
`r predict(model_fires, newdata = nw)`

Прогноз для среднего:
`r predict(model_fires, newdata = nw,interval = "confidence")`

Индивидуальный прогноз:
`r predict(model_fires, newdata = nw,interval = "prediction")`

Можем улучшить индивидуальный прогноз, заметив, что площадь пожара не может быть отрицательной: lwr = 0

Задание 6.
Предполагаю, что переменная synergy будет порождать гетероскедастичность. При неблагоприятных условиях для пожара(низких значениях synergy), пожара скорее всего не будет, площадь пожара будет около 0 с небольшими стандартными ошибками. При благоприятных условиях для пожара(высокой synergy) может случиться как небольшой, так и крупный пожар и разброс в площади выгоревшего леса будет гораздо выше. Поэтому предпологаем гетероскедастичность вида sigma~synergy.

Задание 7. Выявляем гетероскедастичность графически

`r qplot(data = dffires, synergy, sqrt(residuals(model_fires)^2),ylab = "модуль остатков") + stat_smooth(method = "lm")`

Линия регрессии модулей остатков на synergy наклонена, но не очень сильно: ошибки возрастают с увеличением synergy, есть подозрение на гетероскедастичность

Проверим наличие гетероскедастичности с помощью теста Голдфельда-Квандта:
`r gqtest(model_fires, order.by = ~synergy, data = dffires, fraction = 0.3)`
Гипотеза о гомоскедастичности отвергается, имеется явная гетероскедастичнлсть по переменной synergy. В целом, результаты тестов совпали:выявлена гетероскедастичность.
Но тест Голдфельда-Квандта не очень подходит для проверки гетероскедастичности в нашей модели, потому что он предпологает нормальность ошибок, что неверно для нашей модели
Мы можем провести тест Уайта, который также выявит гетероскедастичность
```{r}
bptest(model_fires, data = dffires, varformula = ~poly((lm(data = dffires, abs((residuals(model_fires))) ~ model_fires$fitted.values)$fitted.values), 2))
```
Задание 8.Найдем оценки всвешенного МНК.
Сначала проведем регрессию остатков регрессии(модулей) на предикторы модели
Получив оценку матрицы дисперсий, найдем веса
Наконец, получим оценки WLS
```{r}
fires.weights <- 1/(lm(data = dffires, abs((residuals(model_fires))) ~ model_fires$fitted.values)$fitted.values^2)
model_fires_wls <- lm(data = dffires,
                      area ~ synergy+DMC+temp+RH+wind, 
                      weights = fires.weights)
summary(model_fires_wls)
vif(model_fires_wls)
```
Оценки достаточно сильно изменились. У коэффициента перед переменной wind изменился знак, коэффициенты изменялись разнонаправленно, в среднем модуль коэффициентов уменьшился.
Из очень неожиданного: вместо модели, которая достаточно плохо объясняла целевую переменную, мы получили модель с достаточно приличтным R^2. Правда, вместе с этим мы получили мультиколлинеарность в модели: из-за этого переменные по-прежнему считаются незначимыми.

Задание 9. Найдем робастные стандартные ошибки Уайта. Сразу HC0 и HC3.
```{r}
coeftest(model_fires, vcov = vcovHC(model_fires, type = "HC0"))
coeftest(model_fires, vcov = vcovHC(model_fires, type = "HC3"))
```

Робастные стандартные ошибки отличаются от обычных тем, что для их нахождения мы используем не обычную матрицу дисперсий омега с крышкой, а матрицу корней из диагональных элементов матрицы омега с крышкой. Данное изменение делает ошибки устойчивыми к гетероскедастичности.

Значимость переменных незначительно изменилась по сравнению с линейной моделью: переменная synergy теперь является незначимой, а значимость остальных переменных в среднем немного выросла.
